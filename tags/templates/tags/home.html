{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Tag Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f7f9fc;
            color: #2d3748;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 32px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .word {
            display: inline-block;
            background: #edf2f7;
            padding: 8px 12px;
            margin: 4px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .word.selected {
            background: #4299e1;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-xl font-bold mb-4">Tag Annotator</h2>
        <div id="sentencesContainer" class="p-4 border rounded-lg bg-white shadow-md"></div>
        <div id="currentFileName" class="text-sm text-gray-500 mt-2"></div>

        <select id="tagSelector" class="mt-4 p-2 border rounded">
            <option value="O">Select Tag</option>
            {% for tag in tags %}
            <option value="{{ tag }}">{{ tag }}</option>
            {% endfor %}
        </select>
        <button onclick="assignTag()" class="ml-2 p-2 bg-blue-500 text-white rounded">Assign Tag</button>
        
        <button onclick="submitFile()" class="mt-4 p-2 bg-green-500 text-white rounded">Submit</button>

        <button class="mt-4 p-2 bg-green-500 text-white rounded" onclick="skipFile()">Skip</button>
    </div>

    <script>
        let lines = [];
        let fileName = "";
        let allTagData = [];

        document.addEventListener('DOMContentLoaded', () => {
            fetch('/get_paragraph/')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        lines = data.paragraph.split('.');
                        fileName = data.filename;
                        displayAllLines();
                        document.getElementById('currentFileName').innerText = data.filename;
                    }
                });
        });

        function displayAllLines() {
            let sentencesContainer = document.getElementById('sentencesContainer');
            sentencesContainer.innerHTML = "";

            lines.forEach((line, index) => {
                let words = line.trim().split(' ');
                let tagData = {};
                let sentenceDiv = document.createElement('div');
                sentenceDiv.className = 'mb-4 p-2 border rounded bg-gray-100';
                sentenceDiv.dataset.index = index;

                words.forEach((word, idx) => {
                    let cleanWord = word.replace(/[^a-zA-Z0-9]/g, '');
                    if (cleanWord) {
                        tagData[idx] = { word: cleanWord, tag: "O" };
                        let wordDiv = document.createElement('div');
                        wordDiv.className = 'word';
                        wordDiv.innerText = word;
                        wordDiv.onclick = () => selectWord(wordDiv, index, idx);
                        sentenceDiv.appendChild(wordDiv);
                    }
                });

                allTagData[index] = { sentence_number: index, annotations: tagData };
                sentencesContainer.appendChild(sentenceDiv);
            });
        }

        function selectWord(wordDiv, sentenceIndex, wordIndex) {
            document.querySelectorAll('.word').forEach(w => w.classList.remove('selected'));
            wordDiv.classList.add('selected');
            wordDiv.dataset.sentenceIndex = sentenceIndex;
            wordDiv.dataset.wordIndex = wordIndex;
        }

        function assignTag() {
    let selectedWordDiv = document.querySelector('.word.selected');
    if (!selectedWordDiv) {
        alert("Select a word first!");
        return;
    }
    let selectedTag = document.getElementById('tagSelector').value;
    let sentenceIndex = selectedWordDiv.dataset.sentenceIndex;
    let wordIndex = selectedWordDiv.dataset.wordIndex;
    allTagData[sentenceIndex].annotations[wordIndex].tag = selectedTag;
    console.log(allTagData);
    
    // Color mapping for tags
    const tagColors = {
        'person': 'blue',
        'location': 'green',
        'object':'orange',
        'building':'brown',
        'O': '#edf2f7', // default color for untagged words
        // Add more tags and colors as needed
    };

    // Set background and text color based on the tag
    selectedWordDiv.style.backgroundColor = tagColors[selectedTag] || 'lightblue'; // Default to light gray
    selectedWordDiv.style.color = selectedTag === 'O' ? '#2d3748' : 'white'; // Black text for untagged words, white for others
}

        function submitFile() {
            let formattedTagData = allTagData.map(sentenceData => {
                let annotations = {};
                Object.values(sentenceData.annotations).forEach(({ word, tag }) => {
                    annotations[word] = tag;
                });
                return { sentence_number: sentenceData.sentence_number, annotations };
            });

            let payload = {
                filename: fileName,
                data: formattedTagData
            };
            fetch('/submit_file/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                location.reload();
            });
        }

        function skipFile() {
            const currentFileName = document.getElementById('currentFileName').innerText;

            fetch(`/skip_file/?currentFileName=${encodeURIComponent(currentFileName)}`, {
                method: 'GET',
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Update the lines array and current file
                        lines = data.paragraph.split('.');
                        fileName = data.filename;
                        displayAllLines();
                        document.getElementById('currentFileName').innerText = data.filename;
                    } else {
                        alert("no more files");
                    }
                })
                .catch(error => {
                    console.error("Error skipping file:", error);
                    document.getElementById('paraContent').innerText = "Failed to skip file.";
                });
        }

    </script>
</body>
</html>
